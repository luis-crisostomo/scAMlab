% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/run_scvi_integration.r
\name{run_scvi_integration}
\alias{run_scvi_integration}
\title{Run scVI Integration for Batch Correction in Single-Cell RNA-seq Data}
\usage{
run_scvi_integration(
  seurat_obj,
  int_features,
  filename,
  assay = "RNA",
  scvi.model = NULL,
  ...
)
}
\arguments{
\item{seurat_obj}{A Seurat object containing single-cell RNA-seq data with
multiple batches to integrate}

\item{int_features}{Character vector of feature names (genes) to use for
integration. Typically highly variable genes selected by
\code{\link{custom_VarFeatures}} or \code{\link[Seurat]{FindVariableFeatures}}}

\item{filename}{Character string. Base name used for creating intermediate
AnnData files (stored in data_path directory)}

\item{assay}{Character string. Name of the assay to use for integration.
Default: "RNA"}

\item{scvi.model}{Named list of arguments to pass to
\code{scvi$model$SCVI$setup_anndata()}. Must include \code{batch_key}.
See Details for full description of available arguments. Required.}

\item{...}{Additional arguments passed to \code{scvi$model$SCVI()} model
constructor (e.g., n_latent, n_layers, dispersion, gene_likelihood)}
}
\value{
Returns the input Seurat object with an added "scvi" dimensional
reduction containing the integrated latent representation. The reduction
can be accessed via \code{seurat_obj[["scvi"]]} and has the key "scvi_".
}
\description{
Performs batch correction and data integration using scVI (single-cell
Variational Inference), a deep generative model for single-cell RNA-seq data.
The function automatically optimizes performance parameters based on available
hardware (GPU/CPU, RAM), trains the scVI model, and returns the integrated
latent representation as a dimensional reduction in the Seurat object.
}
\details{
\strong{scVI Model Overview:}

scVI (Lopez et al., 2018) is a probabilistic model that learns a low-dimensional
latent representation of single-cell expression data while accounting for
technical variability including batch effects. Unlike linear methods (e.g.,
Harmony, Seurat integration), scVI uses deep neural networks to model complex,
nonlinear batch effects.

\strong{Understanding batch_key vs. Covariates:}

\strong{batch_key} (REQUIRED):
\itemize{
\item The primary technical variable to correct (e.g., "sample", "batch",
"donor", "library_prep")
\item scVI learns batch-specific parameters to remove systematic differences
\item Must have at least 2 unique values (function checks and warns if not)
\item This is the main variable you want to "integrate across"
}

\strong{categorical_covariate_keys} (OPTIONAL):
\itemize{
\item Additional categorical variables that may affect expression
(e.g., "sex", "age_group", "tissue_region")
\item Model accounts for these but does NOT remove their effects
\item Use when you want to preserve biological variation while correcting batch
\item Can be a vector: c("sex", "age_group")
}

\strong{continuous_covariate_keys} (OPTIONAL):
\itemize{
\item Continuous variables (e.g., "percent_mito", "nCount_RNA", "age_numeric")
\item Model conditions on these variables
\item Use for technical or biological continuous covariates
\item Can be a vector: c("percent_mito", "nCount_RNA")
}

\strong{Example Use Cases:}

\emph{Case 1: Simple batch correction}
\preformatted{
scvi.model = list(
  batch_key = "sample"  # Integrate across samples
)
}

\emph{Case 2: Batch correction while preserving biological effects}
\preformatted{
scvi.model = list(
  batch_key = "batch",                    # Remove batch effects
  categorical_covariate_keys = c("sex")   # Preserve sex differences
)
}

\emph{Case 3: Complex design with multiple covariates}
\preformatted{
scvi.model = list(
  batch_key = "library_prep",
  categorical_covariate_keys = c("donor", "tissue"),
  continuous_covariate_keys = c("percent_mito", "nCount_RNA")
)
}

\strong{Available scvi.model Arguments:}

Arguments passed to \code{scvi$model$SCVI$setup_anndata()}:
\itemize{
\item \strong{batch_key}: (REQUIRED) Column name for batch variable
\item \strong{layer}: Data layer to use (default: NULL, uses .X)
\item \strong{categorical_covariate_keys}: Vector of categorical covariate names
\item \strong{continuous_covariate_keys}: Vector of continuous covariate names
\item \strong{labels_key}: Column name for cell type labels (for conditional scVI)
}

\strong{Available Model Constructor Arguments (...):}

Arguments passed to \code{scvi$model$SCVI()}:
\itemize{
\item \strong{n_latent}: Number of latent dimensions (default: 30)
\item \strong{n_layers}: Number of hidden layers (default: 2)
\item \strong{n_hidden}: Number of nodes per hidden layer (default: 128)
\item \strong{dropout_rate}: Dropout rate (default: 0.1)
\item \strong{dispersion}: Dispersion mode ("gene", "gene-batch", "gene-label"; default: "gene")
\item \strong{gene_likelihood}: Distribution ("zinb", "nb", "poisson"; default: "nb")
}

\strong{Performance Optimization:}

The function automatically optimizes performance based on system resources:

\strong{GPU Mode} (if CUDA GPU available):
\itemize{
\item Batch size: Dynamically calculated based on GPU memory (up to 4096)
\item DataLoader workers: 0-1 for small systems, ≥2 for larger systems
\item Accelerator: "cuda"
\item Uses high precision float32 matrix multiplication
}

\strong{CPU Mode} (if no GPU):
\itemize{
\item Batch size: 512-2048 based on RAM (>16GB → 1024, >32GB → 2048)
\item DataLoader workers: 0 for <32GB RAM, otherwise half of logical processors
\item Accelerator: "cpu"
}

Optimization factors:
\itemize{
\item Larger batch sizes improve GPU utilization but require more memory
\item More workers speed up data loading but increase RAM usage
\item Persistent workers reduce worker startup overhead
\item CSR sparse matrix format optimizes training speed
}

\strong{Training Process:}

The model training includes:
\itemize{
\item Automatic early stopping to prevent overfitting
\item Hardware-optimized batch sizes
\item Progress monitoring during training
\item ELBO (Evidence Lower Bound) convergence tracking
}

\strong{Output Interpretation:}

The function adds a "scvi" dimensional reduction to the Seurat object containing
the learned latent representation (default: 30 dimensions). This latent space:
\itemize{
\item Has batch effects removed
\item Preserves biological variation
\item Can be used for clustering, UMAP, and other downstream analyses
\item Is analogous to PCA but batch-corrected
}

Use the scvi reduction for downstream analysis:
\preformatted{
# Clustering on scvi latent space
seurat_obj <- FindNeighbors(seurat_obj, reduction = "scvi", dims = 1:30)
seurat_obj <- FindClusters(seurat_obj, resolution = 0.5)

# UMAP on scvi latent space
seurat_obj <- RunUMAP(seurat_obj, reduction = "scvi", dims = 1:30)
}
}
\section{System Requirements}{

\itemize{
\item Python packages: scvi-tools, scanpy, anndata, torch
\item R packages: Seurat, scCustomize, reticulate
\item Optional: CUDA-compatible GPU for faster training
\item RAM: Minimum 16GB recommended, 32GB+ for large datasets
}
}

\section{Verbose Output}{

The function prints detailed information during execution:
\itemize{
\item Batch variable validation and unique values found
\item scVI setup arguments being used
\item System configuration (CPU, RAM, GPU)
\item Performance parameters (batch size, workers)
\item Model architecture details
\item Training progress and convergence
\item Final latent representation dimensions
}
}

\examples{
\dontrun{
# Basic integration across samples
seurat_obj <- run_scvi_integration(
  seurat_obj = seurat_obj,
  int_features = VariableFeatures(seurat_obj),
  filename = "my_experiment",
  scvi.model = list(batch_key = "sample")
)

# Integration with biological covariates preserved
seurat_obj <- run_scvi_integration(
  seurat_obj = seurat_obj,
  int_features = hvf_genes,
  filename = "my_experiment",
  scvi.model = list(
    batch_key = "batch",
    categorical_covariate_keys = c("sex", "age_group")
  )
)

# Integration with continuous covariates
seurat_obj <- run_scvi_integration(
  seurat_obj = seurat_obj,
  int_features = hvf_genes,
  filename = "my_experiment",
  scvi.model = list(
    batch_key = "library_prep",
    continuous_covariate_keys = c("percent_mito", "nCount_RNA")
  )
)

# Custom model parameters
seurat_obj <- run_scvi_integration(
  seurat_obj = seurat_obj,
  int_features = hvf_genes,
  filename = "my_experiment",
  scvi.model = list(batch_key = "sample"),
  n_latent = 50,           # More latent dimensions
  n_layers = 3,            # Deeper network
  gene_likelihood = "zinb" # Zero-inflated negative binomial
)

# Use scvi reduction for downstream analysis
seurat_obj <- FindNeighbors(seurat_obj, reduction = "scvi", dims = 1:30)
seurat_obj <- FindClusters(seurat_obj, resolution = 0.5)
seurat_obj <- RunUMAP(seurat_obj, reduction = "scvi", dims = 1:30)
DimPlot(seurat_obj, reduction = "umap", group.by = "sample")
}

}
\references{
Lopez, R., Regier, J., Cole, M. B., Jordan, M. I., & Yosef, N. (2018).
Deep generative modeling for single-cell transcriptomics.
Nature Methods, 15(12), 1053-1058.

scvi-tools documentation: https://docs.scvi-tools.org/
}
\seealso{
\code{\link{custom_VarFeatures}} for selecting integration features
\code{\link[Seurat]{FindVariableFeatures}} for standard HVF selection
\code{\link[Seurat]{IntegrateData}} for Seurat's native integration
}
