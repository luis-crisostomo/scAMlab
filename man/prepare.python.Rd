% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/prepare.python.r
\name{prepare.python}
\alias{prepare.python}
\title{Prepare Python Environment for Single-Cell Analysis}
\usage{
prepare.python(conda_env = "scrna_analysis", python_version = "3.12")
}
\arguments{
\item{conda_env}{Character string. Name of the conda environment to use or
create. Default: "scrna_analysis"}

\item{python_version}{Character string. Python version to use when creating
a new environment. Default: "3.12"}
}
\value{
Invisibly returns TRUE. Called primarily for its side effects of
environment setup and validation.
}
\description{
Checks for and optionally creates a conda environment with Python packages
required for single-cell RNA-seq analysis (CellBender, scVI, Scanpy, etc.).
Automatically detects the operating system and GPU availability to install
appropriate package versions. Validates that all required modules are
importable and offers to reinstall if modules are missing.
}
\details{
\strong{Environment Detection:}

The function automatically detects:
\itemize{
\item \strong{Operating system}: Windows, macOS, or Linux
\item \strong{GPU availability}: Checks for NVIDIA GPU using nvidia-smi
\item \strong{Conda installation}: Searches common installation paths and
shell configuration files
\item \strong{Mamba availability}: Prefers mamba for faster package resolution,
falls back to conda if unavailable
}

\strong{Installed Packages:}

The environment includes:
\itemize{
\item \strong{Core packages}:
\itemize{
\item NumPy 1.26.4 (pinned for compatibility)
\item PyTorch and torchvision (CPU or CUDA version based on GPU availability)
}
\item \strong{Single-cell analysis}:
\itemize{
\item scvi-tools (with appropriate extras: metal for macOS, cuda for
Linux/Windows with GPU)
\item Scanpy (single-cell analysis)
\item CellBender 0.3.0 + latest development version from GitHub
\item Scrublet 0.2.3 (doublet detection)
}
\item \strong{Supporting packages}:
\itemize{
\item JAX 0.6.2
\item UMAP-learn 0.5.8
}
}

\strong{Platform-Specific Installation:}

\strong{macOS}:
\itemize{
\item PyTorch: CPU version (no CUDA support)
\item scvi-tools: metal extras for Apple Silicon GPU acceleration
}

\strong{Windows}:
\itemize{
\item PyTorch: CUDA 12.8 if GPU detected, CPU otherwise
\item scvi-tools: cuda extras if GPU detected
\item Requires CONDA_HOME environment variable set
}

\strong{Linux}:
\itemize{
\item PyTorch: CUDA if GPU detected, CPU otherwise
\item scvi-tools: cuda extras if GPU detected
}

\strong{Conda Discovery:}

The function searches for conda in the following order:
\enumerate{
\item \strong{Windows}: CONDA_HOME environment variable (required)
\item \strong{Unix}: Common installation paths:
\itemize{
\item ~/miniconda3, ~/anaconda3
\item /opt/conda, /opt/miniconda3, /opt/anaconda3
\item /usr/local/miniconda3, /usr/local/anaconda3
}
\item \strong{Unix}: Shell configuration files (.bashrc, .bash_profile,
.zshrc, .profile) for conda.sh sourcing
}

\strong{Interactive Features:}

If required modules are missing from an existing environment, the function:
\enumerate{
\item Lists the missing modules
\item Prompts the user to reinstall
\item Reinstalls all packages if user confirms
}

\strong{Helper Functions:}

The main function uses internal helpers (not exported):
\itemize{
\item \code{find_conda_path()}: Locates conda installation
\item \code{setup_conda_env()}: Creates new conda environment
\item \code{install_conda_packages()}: Installs all required packages
}
}
\note{
\itemize{
\item This function is designed for use with \code{\link{run_scvi_integration}}
and other Python-based single-cell tools
\item Package versions are pinned for stability and compatibility
\item The function uses bash commands and may not work in some restricted
environments
\item Environment creation can take 10-30 minutes depending on internet
speed and system resources
}
}
\section{First-Time Setup}{

On first use, the function will:
\enumerate{
\item Detect conda installation
\item Create the specified environment with Python 3.12
\item Install all required packages (may take 10-30 minutes)
\item Configure reticulate to use the new environment
}
}

\section{Subsequent Uses}{

On subsequent calls, the function:
\enumerate{
\item Activates the existing environment
\item Validates all required modules are importable
\item Offers to reinstall if any modules are missing
}
}

\section{Troubleshooting}{

\strong{Windows}:
\itemize{
\item Set CONDA_HOME: \code{Sys.setenv(CONDA_HOME = "C:/Users/YourName/miniconda3")}
\item Ensure conda/mamba are in System PATH
}

\strong{macOS/Linux}:
\itemize{
\item Ensure conda is initialized in your shell: \code{conda init bash}
\item Check conda.sh is sourced in ~/.bashrc or ~/.zshrc
}

\strong{All platforms}:
\itemize{
\item Install mamba for faster package resolution: \code{conda install mamba -n base -c conda-forge}
\item Check environment exists: \code{conda env list}
}
}

\section{System Requirements}{

\itemize{
\item \strong{Required}: Conda or Miniconda installation
\item \strong{Recommended}: Mamba for faster package installation
\item \strong{Optional}: NVIDIA GPU with CUDA support for GPU acceleration
\item \strong{Disk space}: ~5-10 GB for full environment
\item \strong{Internet}: Required for package downloads
}
}

\examples{
\dontrun{
# Basic usage - creates or checks default environment
prepare.python()

# Use custom environment name
prepare.python(conda_env = "my_scrna_env")

# Specify different Python version
prepare.python(python_version = "3.11")

# For Windows, set CONDA_HOME first
Sys.setenv(CONDA_HOME = "C:/Users/YourName/miniconda3")
prepare.python()

# After setup, Python packages are available via reticulate
library(reticulate)
sc <- import("scanpy")
scvi <- import("scvi")
cb <- import("cellbender")

# Verify GPU availability for PyTorch (if applicable)
torch <- import("torch")
torch$cuda$is_available()  # Should return TRUE if CUDA GPU detected
}

}
\references{
CellBender: https://cellbender.readthedocs.io/

scvi-tools: https://docs.scvi-tools.org/

Scanpy: https://scanpy.readthedocs.io/
}
\seealso{
\code{\link{run_scvi_integration}} for scVI-based batch correction
\code{\link[reticulate]{use_condaenv}} for conda environment management
\code{\link[reticulate]{import}} for importing Python modules
}
